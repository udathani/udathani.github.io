<script>
  function fmtIdr(n){ return new Intl.NumberFormat('id-ID').format(Math.round(n)); }
  function fmtUsd(n){ return new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(n); }

  async function getJson(url, label){
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){
      throw new Error(label + ' HTTP ' + res.status);
    }
    return res.json();
  }

  async function getFngToday(){
    const j = await getJson('https://api.alternative.me/fng/?limit=1&format=json', 'FNG');
    const d = j && j.data && j.data[0];
    if(!d) throw new Error('FNG no data');
    return { value:+d.value, label:d.value_classification, ts:+d.timestamp*1000 };
  }

  // Harga BTC USD: coba CoinGecko, kalau gagal fallback Coinbase
  async function getBtcUsd(){
    // 1) CoinGecko
    try{
      const j = await getJson(
        'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd',
        'CoinGecko'
      );
      const usd = Number(j.bitcoin.usd);
      if(!usd) throw new Error('CoinGecko invalid');
      return usd;
    }catch(e){
      console.log('CoinGecko failed:', e);
    }

    // 2) Coinbase fallback
    const j2 = await getJson('https://api.coinbase.com/v2/prices/BTC-USD/spot', 'Coinbase');
    const usd2 = Number(j2.data.amount);
    if(!usd2) throw new Error('Coinbase invalid');
    return usd2;
  }

  // Kurs USD->IDR (lebih stabil)
  async function getUsdIdr(){
    const j = await getJson('https://open.er-api.com/v6/latest/USD', 'FX');
    const idr = Number(j.rates && j.rates.IDR);
    if(!idr) throw new Error('FX invalid');
    return idr;
  }

  function colorBadge(v, el){
    el.className='badge';
    if(v<=24) el.classList.add('fng-red');
    else if(v<=49) el.classList.add('fng-orange');
    else if(v<=74) el.classList.add('fng-green');
    else el.classList.add('fng-darkgreen');
  }

  function shouldBuy(strategy, v){
    return strategy==='extreme' ? v<=24 : v<=49;
  }

  async function loadFngCard(){
    try{
      const f = await getFngToday();
      document.getElementById('fng-value').textContent = f.value;
      const lab = document.getElementById('fng-label');
      lab.textContent = f.label;
      colorBadge(f.value, lab);
      document.getElementById('fng-time').textContent =
        'Update: ' + new Date(f.ts).toLocaleString('id-ID');
    }catch(e){
      document.getElementById('fng-value').textContent='â€”';
      document.getElementById('fng-label').textContent='Tidak tersedia';
      console.log('FNG card error:', e);
    }
  }

  async function runSim(){
    const amount = +document.getElementById('amountIdr').value || 0;
    if(amount<=0){ alert('Nominal harus > 0'); return; }

    const strategy = document.querySelector('input[name="strategy"]:checked').value;

    // tampilkan hasil box nanti
    document.getElementById('simResult').style.display = 'none';

    try{
      // Ambil data (FNG + BTC USD + FX)
      const [f, btcUsd, usdIdr] = await Promise.all([getFngToday(), getBtcUsd(), getUsdIdr()]);
      const btcIdr = btcUsd * usdIdr;

      const buy = shouldBuy(strategy, f.value);
      const fiat = buy ? amount : 0;
      const btcBought = buy ? (amount / btcIdr) : 0;
      const val = btcBought * btcIdr;

      document.getElementById('rFngValue').textContent = f.value;
      document.getElementById('rFngLabel').textContent = f.label;

      document.getElementById('rBtcUsd').textContent = fmtUsd(btcUsd);
      document.getElementById('rFiat').textContent = fmtIdr(fiat);
      document.getElementById('rBtc').textContent = btcBought.toFixed(8);
      document.getElementById('rValueIdr').textContent = fmtIdr(val);

      const b = document.getElementById('rPnlBadge');
      b.className = 'badge';
      if(val>fiat){ b.textContent='HIJAU'; b.classList.add('fng-green'); }
      else if(val<fiat){ b.textContent='MERAH'; b.classList.add('fng-red'); }
      else b.textContent='NETRAL';

      document.getElementById('simResult').style.display = 'block';

      // GA event
      if(typeof gtag==='function'){
        gtag('event','sim_run',{event_category:'engagement',event_label:strategy});
      }

    }catch(err){
      console.log('SIM error:', err);
      alert('Gagal ambil data: ' + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    loadFngCard();
    const btn = document.getElementById('runSimBtn');
    btn.addEventListener('click', (e)=>{ e.preventDefault(); runSim(); });
  });
</script>
